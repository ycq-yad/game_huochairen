{
  "code": "import * as tslib_1 from \"tslib\";\r\nimport { GameData } from \"../../../common/GameData\";\r\nimport SoundManager, { SoundConst } from \"../../../manager/SoundManager\";\r\nimport { BrushScene } from \"./brush/BrushScene\";\r\nimport Type2GameLineToolMgr, { LinePoints } from \"../../Type2GameLineToolMgr\";\r\nimport SkinMgr from \"../../../manager/SkinMgr\";\r\nimport GameEvent from \"../../../common/GameEvent\";\r\nimport { MiniManeger } from \"../../../minigame/MiniManeger\";\r\nimport ConfigManager from \"../../../manager/ConfigManager\";\r\nimport { TipScene2 } from \"./TipScene2\";\r\nimport AnimationManager from \"../../../manager/AnimationManager\";\r\nimport GameInfoManager from \"../../../manager/GameInfoManager\";\r\nimport GameMgr from \"../../../manager/GameMgr\";\r\nvar GameSceneType2 = (function (_super) {\r\n    tslib_1.__extends(GameSceneType2, _super);\r\n    function GameSceneType2(data) {\r\n        var _this = _super.call(this) || this;\r\n        _this.className_key = \"GameSceneType2\";\r\n        _this.isRecord = false;\r\n        _this.playSound = false;\r\n        _this.isSuccess = false;\r\n        _this.isEnd = false;\r\n        _this.currentAllPoints = [];\r\n        _this.curentLineColor = \"#ff0000\";\r\n        _this.deltaY = 0;\r\n        _this.deltaX = 0;\r\n        _this.viewData_ = data;\r\n        _this.skin = \"levels/type2/Type2GameScene.json\";\r\n        return _this;\r\n    }\r\n    GameSceneType2.prototype.removeEvent = function () {\r\n        this.btn_back.off(Laya.Event.CLICK, this, this.onBackUglify);\r\n        this.btn_skin.off(Laya.Event.CLICK, this, this.onSkinUglify);\r\n        this.btn_clear.off(Laya.Event.CLICK, this, this.onClearUglify);\r\n        this.btn_tip.off(Laya.Event.CLICK, this, this.onTipUglify);\r\n        this.btn_pass.off(Laya.Event.CLICK, this, this.onPassUglify);\r\n        this.btn_record.off(Laya.Event.CLICK, this, this.onRecord);\r\n        this.box_draw.off(Laya.Event.CLICK, this, this.onDraw);\r\n        EventMgr.getInstance().removeEvent(GameEvent.USE_BRUSH, this, this.updateBrush);\r\n        EventMgr.getInstance().removeEvent(GameEvent.Type2Next, this, this.onNextUglify);\r\n        EventMgr.getInstance().removeEvent(GameEvent.Type2Restart, this, this.onRestartUglify);\r\n    };\r\n    GameSceneType2.prototype.onRemoved = function () {\r\n        _super.prototype.onRemoved.call(this);\r\n        this.removeEvent();\r\n        this.viewData_ = null;\r\n        this.clearUglify();\r\n        if (this.levelSke) {\r\n            this.levelSke.offAll();\r\n            this.levelSke.removeSelf();\r\n            this.levelSke = null;\r\n        }\r\n        if (this.starSke) {\r\n            this.starSke.offAll();\r\n            this.starSke.removeSelf();\r\n            this.starSke = null;\r\n        }\r\n        EventMgr.getInstance().sendEvent(GameEvent.HIDE_GAME_BANNER, this.box_banner);\r\n    };\r\n    GameSceneType2.prototype.initView = function () {\r\n        this.mouseEnabled = true;\r\n        if (!this.grpDraw) {\r\n            this.grpDraw = new Laya.Sprite();\r\n            this.img_baseBoard.addChild(this.grpDraw);\r\n        }\r\n        this.img_baseBoard.visible = false;\r\n        this.grpDraw.visible = false;\r\n        this.deltaY = (Laya.stage.height - 1044 - 60);\r\n        this.deltaX = (Laya.stage.width - 1036) / 2;\r\n        this.startGame();\r\n        this.updateBrush();\r\n    };\r\n    GameSceneType2.prototype.startGame = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (GameData.getInstance().channel == \"duyou\" && DeviceUtil.isWXMiniGame()) {\r\n                            MiniManeger.instance.hideBanner();\r\n                            this.box_banner.visible = true;\r\n                            EventMgr.getInstance().sendEvent(GameEvent.SHOW_GAME_BANNER, this.box_banner);\r\n                            GameMgr.instance.topBarIsShow = false;\r\n                            GameMgr.instance.bannerIsShow = false;\r\n                        }\r\n                        if (DeviceUtil.isTTMiniGame()) {\r\n                            MiniManeger.instance.hideBanner();\r\n                        }\r\n                        EventMgr.getInstance().sendEvent(GameEvent.BUFFER_LOAD, true);\r\n                        this.clearUglify();\r\n                        return [4, this.updateLevel()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.addTemplate();\r\n                        this.mouseEnabled = true;\r\n                        EventMgr.getInstance().sendEvent(GameEvent.BUFFER_LOAD, false);\r\n                        this.initRecord();\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GameSceneType2.prototype.initRecord = function () {\r\n        if (DeviceUtil.isTTMiniGame()) {\r\n            this.btn_record.visible = true;\r\n            this.isRecord = false;\r\n            if (GameData.getInstance().autoMakeVideo) {\r\n                this.startGameRecord();\r\n            }\r\n            else {\r\n                this.btn_record.skin = \"resource/assets/imgs/public/lz1.png\";\r\n                this.btn_record.getChildByName(\"lab\").text = \"录制\";\r\n            }\r\n        }\r\n        else {\r\n            this.btn_record.visible = false;\r\n        }\r\n    };\r\n    GameSceneType2.prototype.onRecord = function () {\r\n        var lab = this.btn_record.getChildByName(\"lab\");\r\n        if (!this.isRecord) {\r\n            this.startGameRecord();\r\n        }\r\n        else {\r\n            this.stopGameRecord();\r\n        }\r\n    };\r\n    GameSceneType2.prototype.startGameRecord = function () {\r\n        var _this = this;\r\n        var lab = this.btn_record.getChildByName(\"lab\");\r\n        if (!this.isRecord) {\r\n            this.isRecord = true;\r\n            this.btn_record.skin = \"resource/assets/imgs/public/lz2.png\";\r\n            lab.text = \"录制中\";\r\n            MiniManeger.instance.startGameRecord({\r\n                startFun: function () { },\r\n                stopFun: function () {\r\n                    _this.isRecord = false;\r\n                    lab.text = \"录制\";\r\n                    _this.btn_record.skin = \"resource/assets/imgs/public/lz1.png\";\r\n                }\r\n            });\r\n        }\r\n    };\r\n    GameSceneType2.prototype.stopGameRecord = function (force) {\r\n        if (force === void 0) { force = false; }\r\n        MiniManeger.instance.stopGameRecord(force);\r\n    };\r\n    GameSceneType2.prototype.addTemplate = function () {\r\n        this.registPointsUglify();\r\n        Laya.stage.on(Laya.Event.MOUSE_DOWN, this, this.onMouseDownUglify);\r\n    };\r\n    GameSceneType2.prototype.registPointsUglify = function () {\r\n        Type2GameLineToolMgr.getInstance().addLinesPoints([{ name: \"templat_0\", points: this.levelConf.points }]);\r\n    };\r\n    GameSceneType2.prototype.updateBrush = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, SkinMgr.instance.getCurBrushDataUglify()];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        if (!data)\r\n                            return [2];\r\n                        this.img_baseBoard.skin = \"resource/assets/imgs/game/type2/brushs/\" + data.icon + \".png\";\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GameSceneType2.prototype.updateLevel = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this;\r\n                        return [4, ConfigManager.instance.getLevelConf2(this.viewData_.level)];\r\n                    case 1:\r\n                        _a.levelConf = _b.sent();\r\n                        console.log(\"关卡配置\", this.levelConf);\r\n                        this.lab_level.text = \"关卡\" + this.viewData_.level;\r\n                        this.lab_title.text = this.levelConf.title;\r\n                        this.showLevelAni();\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GameSceneType2.prototype.showLevelAni = function () {\r\n        var _this = this;\r\n        var url = \"resource/assets/imgs/levels/type2/\" + this.viewData_.level + \"/level\" + this.viewData_.level + \".sk\";\r\n        if (!this.levelSke) {\r\n            this.levelSke = new Laya.Skeleton();\r\n            this.box_ani.addChild(this.levelSke);\r\n        }\r\n        this.levelSke.load(url, Laya.Handler.create(this, function () {\r\n            if (!_this.levelSke.player)\r\n                return;\r\n            _this.levelSke.player.playbackRate = 1;\r\n            _this.levelSke.scale(_this.levelConf.idle.scaleX, _this.levelConf.idle.scaleY);\r\n            _this.levelSke.pos(_this.levelConf.idle.x, _this.levelConf.idle.y);\r\n            _this.box_ani.visible = true;\r\n            _this.levelSke.play(_this.levelConf.idle.name, _this.levelConf.idle.loop);\r\n        }));\r\n    };\r\n    GameSceneType2.prototype.showStarAni = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n            var _a;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        if (!!this.starSke) return [3, 2];\r\n                        _a = this;\r\n                        return [4, AnimationManager.instance.creatBoonAnimation(\"resource/assets/imgs/levels/type2/type2_star.sk\")];\r\n                    case 1:\r\n                        _a.starSke = _b.sent();\r\n                        if (!this.starSke)\r\n                            resolve();\r\n                        _b.label = 2;\r\n                    case 2:\r\n                        this.box_ani.addChild(this.starSke);\r\n                        this.starSke.pos(this.levelConf.star.x, this.levelConf.star.y);\r\n                        this.starSke.player.once(Laya.Event.STOPPED, this, function () {\r\n                            _this.starSke.visible = false;\r\n                            _this.starSke.removeSelf();\r\n                            resolve();\r\n                        });\r\n                        this.starSke.visible = true;\r\n                        this.starSke.play(0, false);\r\n                        return [2];\r\n                }\r\n            });\r\n        }); });\r\n    };\r\n    GameSceneType2.prototype.clearUglify = function () {\r\n        this.btn_pass.visible = false;\r\n        Laya.Tween.clearAll(this.btn_pass);\r\n        this.btn_pass.scale(1, 1);\r\n        this.btn_back.visible = this.btn_skin.visible = this.btn_tip.visible = this.btn_clear.visible = true;\r\n        this.currDraw = null;\r\n        this.grpDraw.removeChildren();\r\n        this.currentAllPoints = [];\r\n        this.img_baseBoard.visible = false;\r\n        this.img_baseBoard.mask = null;\r\n        this.timer.clearAll(this);\r\n        this.lab_tip.text = \"\";\r\n        this.isSuccess = false;\r\n        this.isEnd = false;\r\n    };\r\n    GameSceneType2.prototype.onMouseDownUglify = function (evt) {\r\n        if (evt.target != this.box_draw)\r\n            return;\r\n        this.timer.clearAll(this);\r\n        if (!this.isSuccess)\r\n            this.lab_tip.text = \"绘图中\";\r\n        this.currentPoints = [];\r\n        this.currentPoints.push(evt.stageX - this.deltaX);\r\n        this.currentPoints.push(evt.stageY - this.deltaY);\r\n        this.currDraw = new Laya.Sprite();\r\n        this.grpDraw.addChild(this.currDraw);\r\n        this.drawLinesUglify();\r\n        this.img_baseBoard.visible = true;\r\n        this.img_baseBoard.mask = this.grpDraw;\r\n        Laya.stage.on(Laya.Event.MOUSE_MOVE, this, this.onMouseMoveUglify);\r\n        Laya.stage.on(Laya.Event.MOUSE_UP, this, this.onMouseUpUglify);\r\n        Laya.stage.on(Laya.Event.MOUSE_OUT, this, this.onMouseUpUglify);\r\n    };\r\n    GameSceneType2.prototype.onMouseMoveUglify = function (evt) {\r\n        if (evt.target != this.box_draw)\r\n            return;\r\n        if (!this.playSound) {\r\n            this.playSound = true;\r\n            SoundManager.instance.playEffect(SoundConst.Huaxian);\r\n        }\r\n        this.currentPoints.push(evt.stageX - this.deltaX);\r\n        this.currentPoints.push(evt.stageY - this.deltaY);\r\n        this.drawLinesUglify();\r\n    };\r\n    GameSceneType2.prototype.drawLinesUglify = function () {\r\n        this.grpDraw.graphics.clear();\r\n        this.currDraw.graphics.clear();\r\n        this.currDraw.graphics.drawLines(0, 0, this.currentPoints, this.curentLineColor, 10);\r\n    };\r\n    GameSceneType2.prototype.onMouseUpUglify = function (evt) {\r\n        Laya.stage.off(Laya.Event.MOUSE_MOVE, this, this.onMouseMoveUglify);\r\n        Laya.stage.off(Laya.Event.MOUSE_UP, this, this.onMouseUpUglify);\r\n        Laya.stage.off(Laya.Event.MOUSE_OUT, this, this.onMouseUpUglify);\r\n        this.playSound = false;\r\n        this.addCurrentLine();\r\n    };\r\n    GameSceneType2.prototype.addCurrentLine = function () {\r\n        var itemLine = new LinePoints();\r\n        itemLine.name = \"templat_\" + this.currentAllPoints.length;\r\n        itemLine.points = this.currentPoints;\r\n        this.currentAllPoints.push(itemLine);\r\n        console.log(\"添加当前线段的数据 >>>\", this.currentAllPoints);\r\n        if (this.isSuccess) {\r\n            this.timer.once(2000, this, this.gameOverUglify, [3]);\r\n        }\r\n        else {\r\n            this.lab_tip.text = \"校验中\";\r\n            this.timer.once(2000, this, this.onCheckUglify);\r\n        }\r\n    };\r\n    GameSceneType2.prototype.onCheckUglify = function () {\r\n        var isSuc = Type2GameLineToolMgr.getInstance().checkAllLinesPoints(this.currentAllPoints, this.levelConf.perset);\r\n        console.log(\"校验 >>>\", this.currentAllPoints, isSuc);\r\n        if (isSuc) {\r\n            this.checkSucc();\r\n        }\r\n        else {\r\n            this.isSuccess = false;\r\n            this.lab_tip.text = \"校验失败\";\r\n        }\r\n    };\r\n    GameSceneType2.prototype.checkSucc = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.isSuccess = true;\r\n                        this.lab_tip.text = \"校验成功\";\r\n                        this.btn_back.visible = this.btn_skin.visible = this.btn_tip.visible = this.btn_clear.visible = false;\r\n                        this.btn_pass.visible = true;\r\n                        EffectUtil.showScaleFix(this.btn_pass, 1.2, 500, true);\r\n                        return [4, this.showStarAni()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.levelSke.stop();\r\n                        this.levelSke.player.once(Laya.Event.STOPPED, this, function () {\r\n                            !_this.isEnd && _this.timer.once(2000, _this, _this.gameOverUglify, [2]);\r\n                        });\r\n                        this.levelSke.play(this.levelConf.succ.name, this.levelConf.succ.loop);\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GameSceneType2.prototype.onNextUglify = function (data) {\r\n        console.log(\"下一关 >>>\", data);\r\n        this.viewData_.level = data.level;\r\n        this.startGame();\r\n    };\r\n    GameSceneType2.prototype.onRestartUglify = function () {\r\n        console.log(\"重玩\");\r\n        this.startGame();\r\n    };\r\n    GameSceneType2.prototype.onBackUglify = function () {\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        this.stopGameRecord(true);\r\n        EventMgr.getInstance().sendEvent(GameEvent.OPEN_SCENE, { name: \"HomeScene\" });\r\n    };\r\n    GameSceneType2.prototype.onSkinUglify = function () {\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        ViewManager.getInstance().showView(BrushScene, { type: 2 });\r\n    };\r\n    GameSceneType2.prototype.onClearUglify = function () {\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        this.clearUglify();\r\n    };\r\n    GameSceneType2.prototype.onTipUglify = function () {\r\n        var _this = this;\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        if (GameData.getInstance().videoOpen) {\r\n            MiniManeger.instance.playViderAd({\r\n                successFun: function () {\r\n                    ViewManager.getInstance().showView(TipScene2, { level: _this.viewData_.level });\r\n                },\r\n                failFun: function () {\r\n                },\r\n                errorFun: function () {\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            MiniManeger.instance.shareAppMessage({\r\n                sucFun: function () {\r\n                    ViewManager.getInstance().showView(TipScene2, { level: _this.viewData_.level });\r\n                },\r\n                failFun: function () {\r\n                }\r\n            });\r\n        }\r\n    };\r\n    GameSceneType2.prototype.onPassUglify = function () {\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        this.gameOverUglify(1);\r\n    };\r\n    GameSceneType2.prototype.gameOverUglify = function (id) {\r\n        console.log(\"游戏结束\", id);\r\n        this.isEnd = true;\r\n        this.timer.clearAll(this);\r\n        this.mouseEnabled = false;\r\n        this.stopGameRecord(true);\r\n        Laya.stage.off(Laya.Event.MOUSE_DOWN, this, this.onMouseDownUglify);\r\n        EventMgr.getInstance().sendEvent(GameEvent.Type2GameOver, { level: this.viewData_.level });\r\n        this.box_ani.visible = false;\r\n        GameInfoManager.getInstance().saveLevelDataById(this.viewData_.level, this.currentAllPoints);\r\n    };\r\n    GameSceneType2.prototype.onDraw = function () {\r\n    };\r\n    GameSceneType2.prototype.childrenCreated = function () {\r\n        _super.prototype.childrenCreated.call(this);\r\n        DeviceUtil.adaptationBgImg(this.img_bg);\r\n        if (DeviceUtil.getIsIphoneX()) {\r\n            this.btn_back.top += GameData.getInstance().fullScreenOffSet;\r\n            this.lab_level.top += GameData.getInstance().fullScreenOffSet;\r\n        }\r\n        if (GameData.getInstance().isConVersion) {\r\n            this.btn_tip.visible = this.btn_skin.visible = false;\r\n        }\r\n        if (GameData.getInstance().videoOpen) {\r\n            this.btn_tip.getChildByName(\"icon\").skin = \"resource/assets/imgs/public/game_icon_4.png\";\r\n        }\r\n        else {\r\n            this.btn_tip.getChildByName(\"icon\").skin = \"resource/assets/imgs/public/settlement_icon_5.png\";\r\n        }\r\n        if (DeviceUtil.isTTMiniGame()) {\r\n            this.img_tipbox.bottom = 80;\r\n            this.btn_clear.bottom = 150;\r\n            this.btn_tip.bottom = 150;\r\n        }\r\n    };\r\n    GameSceneType2.prototype.onAddStage = function () {\r\n        _super.prototype.onAddStage.call(this);\r\n        if (this.isCreate) {\r\n            this.addEvent();\r\n        }\r\n    };\r\n    GameSceneType2.prototype.setData = function (data) {\r\n        this.viewData_ = data;\r\n        if (this.isCreate) {\r\n            this.initView();\r\n        }\r\n    };\r\n    GameSceneType2.prototype.addEvent = function () {\r\n        this.btn_back.on(Laya.Event.CLICK, this, this.onBackUglify);\r\n        this.btn_skin.on(Laya.Event.CLICK, this, this.onSkinUglify);\r\n        this.btn_clear.on(Laya.Event.CLICK, this, this.onClearUglify);\r\n        this.btn_tip.on(Laya.Event.CLICK, this, this.onTipUglify);\r\n        this.btn_pass.on(Laya.Event.CLICK, this, this.onPassUglify);\r\n        this.btn_record.on(Laya.Event.CLICK, this, this.onRecord);\r\n        this.box_draw.on(Laya.Event.CLICK, this, this.onDraw);\r\n        EventMgr.getInstance().addEvent(GameEvent.USE_BRUSH, this, this.updateBrush);\r\n        EventMgr.getInstance().addEvent(GameEvent.Type2Next, this, this.onNextUglify);\r\n        EventMgr.getInstance().addEvent(GameEvent.Type2Restart, this, this.onRestartUglify);\r\n    };\r\n    return GameSceneType2;\r\n}(BaseSceneUISkin));\r\nexport { GameSceneType2 };\r\n",
  "references": [
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameData.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/SoundManager.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/views/games/type2/brush/BrushScene.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/views/Type2GameLineToolMgr.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/SkinMgr.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameEvent.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/minigame/MiniManeger.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/ConfigManager.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/views/games/type2/TipScene2.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/tool/ImageCheckUtil.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/AnimationManager.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/GameInfoManager.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/GameMgr.ts"
  ]
}
