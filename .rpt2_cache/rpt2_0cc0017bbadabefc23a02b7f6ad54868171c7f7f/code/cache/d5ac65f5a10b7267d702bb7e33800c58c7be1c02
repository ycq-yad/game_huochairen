{
  "code": "import * as tslib_1 from \"tslib\";\r\nimport { MiniManeger } from \"./MiniManeger\";\r\nimport { GameData } from \"../common/GameData\";\r\nimport GameEvent from \"../common/GameEvent\";\r\nvar WXGameMgr = (function (_super) {\r\n    tslib_1.__extends(WXGameMgr, _super);\r\n    function WXGameMgr() {\r\n        var _this = _super.call(this) || this;\r\n        _this.appid = \"wx2947380262b38961\";\r\n        _this.secret = \"2b7eb6a3f2f385fc2e2e8625aa642b95\";\r\n        _this.url = \"https://yxtest.32yx.com/MiniGame.fcgi\";\r\n        _this.hideTime = 0;\r\n        _this.showTime = 0;\r\n        _this.sucTime = 3000;\r\n        _this.defaultMssage = {\r\n            \"title\": \"魔性火柴人在线涂鸦！\",\r\n            \"imageUrl\": \"https://package.32yx.com/ecy_game_small/laya/firePeople2/wx_res/share1.jpg\",\r\n            \"query\": \"\"\r\n        };\r\n        _this.shareInfo = [\r\n            {\r\n                \"title\": \"魔性火柴人在线涂鸦！\",\r\n                \"imageUrl\": \"https://package.32yx.com/ecy_game_small/laya/firePeople2/wx_res/share1.jpg\",\r\n                \"query\": \"\"\r\n            }\r\n        ];\r\n        _this.canShowBanner = true;\r\n        return _this;\r\n    }\r\n    WXGameMgr.prototype.initMiniGame = function () {\r\n        var _this = this;\r\n        this.launchOption = wx.getLaunchOptionsSync();\r\n        console.log(\"launchOption >> \", this.launchOption);\r\n        this.systemInfo = wx.getSystemInfoSync();\r\n        console.log(\"systemInfo >> \", this.systemInfo);\r\n        wx.setKeepScreenOn({ keepScreenOn: true });\r\n        wx.updateShareMenu({ withShareTicket: true });\r\n        wx.showShareMenu({ withShareTicket: true });\r\n        this.defaultMssage.imageUrl = this.defaultMssage.imageUrl + \"?v=\" + new Date().getTime();\r\n        wx.onShareAppMessage(function () {\r\n            return _this.defaultMssage;\r\n        });\r\n        this.getUpdateManager();\r\n        Laya.timer.once(10000, this, function () {\r\n            console.log(\"加速回收---\");\r\n            wx.triggerGC();\r\n        });\r\n    };\r\n    WXGameMgr.prototype.onShow = function (callBack) {\r\n        var _this = this;\r\n        wx.onShow(function (res) {\r\n            callBack && callBack(res);\r\n            _this.showTime = new Date().getTime();\r\n            if (_this.showTime - _this.hideTime >= _this.sucTime) {\r\n                _this.shareSucFun && _this.shareSucFun.call(_this.thisObj);\r\n            }\r\n            else {\r\n                _this.shareFailFun && _this.shareFailFun.call(_this.thisObj);\r\n            }\r\n            _this.shareSucFun = null;\r\n            _this.shareFailFun = null;\r\n            _this.thisObj = null;\r\n            EventMgr.getInstance().sendEvent(GameEvent.ONSHOW);\r\n        });\r\n    };\r\n    WXGameMgr.prototype.onHide = function (callBack) {\r\n        var _this = this;\r\n        wx.onHide(function () {\r\n            callBack && callBack();\r\n            _this.hideTime = new Date().getTime();\r\n            EventMgr.getInstance().sendEvent(GameEvent.ONHIDE);\r\n        });\r\n    };\r\n    WXGameMgr.prototype.onAudioInterruptionBegin = function (callBack) {\r\n        wx.onAudioInterruptionBegin(function () {\r\n            callBack && callBack();\r\n        });\r\n    };\r\n    WXGameMgr.prototype.onAudioInterruptionEnd = function (callBack) {\r\n        wx.onAudioInterruptionEnd(function () {\r\n            callBack && callBack();\r\n        });\r\n    };\r\n    WXGameMgr.prototype.loginGame = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.login().then(function (res) {\r\n                res = JSON.parse(res);\r\n                GameData.getInstance().userInfo.openId = res.openid;\r\n                GameData.getInstance().userInfo.sessionKey = res.session_key;\r\n                _this.initUserInfo();\r\n                resolve();\r\n            }).catch(function (err) {\r\n                reject();\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.checkSession = function () {\r\n        return new Promise(function (resolve) {\r\n            wx.checkSession({\r\n                success: function (res) {\r\n                    console.log(\"session未过期\", res);\r\n                    resolve(false);\r\n                },\r\n                fail: function (res) {\r\n                    console.log(\"session已过期，需要重新登录\", res);\r\n                    resolve(true);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.login = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            wx.login({\r\n                success: function (res) {\r\n                    if (res.code) {\r\n                        console.log(\"code：\", res.code);\r\n                        var urlappend = \"appid=\" + _this.appid + \"&secret=\" + _this.secret + \"&js_code=\" + res.code + \"&grant_type=authorization_code\";\r\n                        wx.request({\r\n                            url: _this.url,\r\n                            method: \"POST\",\r\n                            data: {\r\n                                msg_type: \"1\",\r\n                                msg_data: {\r\n                                    url_append: urlappend,\r\n                                }\r\n                            },\r\n                            success: function (res2) {\r\n                                console.log(\"getsisson 返回：\", res2);\r\n                                resolve(res2.data.msg_data);\r\n                            },\r\n                            fail: function (res3) {\r\n                                console.warn(\"网络请求失败：\", res3);\r\n                                reject();\r\n                            }\r\n                        });\r\n                    }\r\n                    else {\r\n                        console.warn(\"登录失败：\", res);\r\n                        reject();\r\n                    }\r\n                },\r\n                fail: function (err) {\r\n                    console.log(\"login调用失败\", err);\r\n                    reject();\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.queryAuthorization = function (scope) {\r\n        return new Promise(function (resolve) {\r\n            wx.getSetting({\r\n                success: function (res) {\r\n                    if (res.authSetting[scope]) {\r\n                        resolve(true);\r\n                    }\r\n                    else {\r\n                        resolve(false);\r\n                    }\r\n                },\r\n                fail: function (res) {\r\n                    resolve(false);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.getUserInfo = function () {\r\n        return new Promise(function (resolve) {\r\n            wx.getUserInfo({\r\n                withCredentials: false,\r\n                lang: 'zh_CN',\r\n                success: function (res) {\r\n                    console.log(\"获取用户信息成功！\", res);\r\n                    resolve(res.userInfo);\r\n                },\r\n                fail: function (res) {\r\n                    console.log(\"用户未授权\", res);\r\n                    resolve(null);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.createUserInfoButton = function () {\r\n        return new Promise(function (resolve, reject) {\r\n            console.log(\"创建用户信息授权按钮\");\r\n            var button = wx.createUserInfoButton({\r\n                type: \"text\",\r\n                text: \"\",\r\n                style: {\r\n                    left: -300,\r\n                    top: 0,\r\n                    width: 2000,\r\n                    height: 4000,\r\n                    backgroundColor: \"#00000000\",\r\n                    borderColor: \"#00000000\",\r\n                    borderWidth: 1,\r\n                    borderRadius: 1,\r\n                    color: \"#00000000\",\r\n                    textAlign: 'center',\r\n                    fontSize: 16,\r\n                    lineHeight: 40\r\n                },\r\n                withCredentials: false,\r\n                lang: 'zh_CN'\r\n            });\r\n            button.onTap(function (res) {\r\n                console.log(\"用户授权成功！\", res);\r\n                button.destroy();\r\n                resolve(res.userInfo);\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.initUserInfo = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var info;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, this.getUserInfo()];\r\n                    case 1:\r\n                        info = _a.sent();\r\n                        if (!!info) return [3, 3];\r\n                        return [4, this.createUserInfoButton()];\r\n                    case 2:\r\n                        info = _a.sent();\r\n                        _a.label = 3;\r\n                    case 3:\r\n                        console.log(\"获取用户的基本信息:\", info);\r\n                        GameData.getInstance().userInfo.nick = info.nickName;\r\n                        GameData.getInstance().userInfo.avatarUrl = info.avatarUrl;\r\n                        GameData.getInstance().userInfo.sex = info.gender;\r\n                        this.defaultMssage.imageUrl = this.defaultMssage.imageUrl + \"?v=\" + new Date().getTime();\r\n                        this.defaultMssage.query = \"openid=\" + GameData.getInstance().userInfo.openId;\r\n                        wx.onShareAppMessage(function () {\r\n                            return _this.defaultMssage;\r\n                        });\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WXGameMgr.prototype.getUpdateManager = function () {\r\n        var updateManager = wx.getUpdateManager();\r\n        updateManager.onCheckForUpdate(function (res) {\r\n            console.log(\"是否有新版本:\", res);\r\n        });\r\n        updateManager.onUpdateReady(function () {\r\n            wx.showModal({\r\n                title: \"更新提示\",\r\n                showCancel: false,\r\n                content: \"新版本已经准备好，是否重启应用？\",\r\n                success: function (res) {\r\n                    res.confirm && updateManager.applyUpdate();\r\n                }\r\n            });\r\n        });\r\n        updateManager.onUpdateFailed(function (err) {\r\n            console.warn(\"新版本更新失败:\", err);\r\n        });\r\n    };\r\n    WXGameMgr.prototype.getShareInfo = function (query) {\r\n        var shareInfo = this.shareInfo;\r\n        var info = shareInfo[Math.floor(Math.random() * shareInfo.length)];\r\n        if (query) {\r\n            var openId = GameData.getInstance().userInfo.openId;\r\n            query[\"openid\"] = openId;\r\n        }\r\n        info.imageUrl = info.imageUrl + \"?v=\" + new Date().getTime();\r\n        info.query = Utils.querStr(query);\r\n        return info;\r\n    };\r\n    WXGameMgr.prototype.shareAppMessage = function (data) {\r\n        if (!data)\r\n            data = {};\r\n        this.shareSucFun = data.sucFun;\r\n        this.shareFailFun = function () {\r\n            TipsManager.getInstance().showDefaultTips(\"分享失败，请分享到群里\");\r\n            data.failFun && data.failFun();\r\n            ;\r\n        };\r\n        this.thisObj = data.thisObj;\r\n        this.sucTime = data.time || this.sucTime;\r\n        if (!data.message) {\r\n            data.message = this.getShareInfo({});\r\n        }\r\n        wx.shareAppMessage(data.message);\r\n    };\r\n    WXGameMgr.prototype.playViderAd = function (data) {\r\n        var _this = this;\r\n        if (!this.infos.videoOpen) {\r\n            data.errorFun && data.errorFun();\r\n            return;\r\n        }\r\n        var videoId = this.infos.videoId;\r\n        if (data.isLongVideo) {\r\n            videoId = this.infos.longVideoId;\r\n        }\r\n        if (videoId.length <= 0) {\r\n            TipsManager.getInstance().showDefaultTips(\"开发中\");\r\n            data.errorFun && data.errorFun();\r\n            return;\r\n        }\r\n        wx.showLoading({ title: \"广告加载中\", mask: true });\r\n        var createCall = function () {\r\n            var adId = videoId[Math.floor(Math.random() * videoId.length)];\r\n            _this.videoAd = wx.createRewardedVideoAd({\r\n                adUnitId: adId\r\n            });\r\n            _this.videoAd.onError(errorCall);\r\n            _this.videoAd.onLoad(loadCall);\r\n            _this.videoAd.onClose(closeCall);\r\n        };\r\n        var loadCall = function (res) {\r\n            console.log(\"激励视频广告 加载成功\", res);\r\n            _this.videoAd.offError(errorCall);\r\n            _this.videoAd.offLoad(loadCall);\r\n            showCall(false);\r\n        };\r\n        var closeCall = function (res) {\r\n            console.log(\"激励视频广告 关闭\", res);\r\n            if (res && res.isEnded) {\r\n                data.successFun && data.successFun();\r\n            }\r\n            else {\r\n                data.failFun && data.failFun();\r\n            }\r\n            _this.videoAd.offClose(closeCall);\r\n            _this.videoAd.offError(errorCall);\r\n            _this.videoAd.offLoad(loadCall);\r\n        };\r\n        var errorCall = function (err) {\r\n            console.warn(\"激励视频广告 错误\", err);\r\n            data.errorFun && data.errorFun(err);\r\n            _this.videoAd.offClose(closeCall);\r\n            _this.videoAd.offError(errorCall);\r\n            _this.videoAd.offLoad(loadCall);\r\n            _this.videoAd.destroy && _this.videoAd.destroy();\r\n            _this.videoAd = null;\r\n            wx.hideLoading({});\r\n        };\r\n        var showCall = function (reload) {\r\n            var fun = function () {\r\n                _this.videoAd.show().then(function () {\r\n                    console.log(\"激励视频广告 显示成功\");\r\n                    wx.hideLoading({});\r\n                }).catch(function (err) {\r\n                    errorCall(err);\r\n                });\r\n            };\r\n            if (reload) {\r\n                _this.videoAd.load().then(function () {\r\n                    console.log(\"激励视频广告 加载成功\");\r\n                    fun();\r\n                }).catch(function (err) {\r\n                    errorCall(err);\r\n                });\r\n            }\r\n            else {\r\n                fun();\r\n            }\r\n        };\r\n        if (!this.videoAd) {\r\n            createCall();\r\n        }\r\n        else {\r\n            this.videoAd.onClose(closeCall);\r\n            showCall(true);\r\n        }\r\n    };\r\n    WXGameMgr.prototype.showBannerAd = function (offset) {\r\n        var _this = this;\r\n        var bannerId = this.infos.bannerId;\r\n        if (!this.infos.bannerOpen || bannerId.length <= 0)\r\n            return;\r\n        this.canShowBanner = true;\r\n        if (!this.bannerAd) {\r\n            var adId = bannerId[Math.floor(Math.random() * bannerId.length)];\r\n            console.log(\"创建 banner 广告组件-->\", adId);\r\n            var phone = this.systemInfo;\r\n            var w_1 = phone.windowWidth;\r\n            var h_1 = phone.windowHeight;\r\n            this.bannerAd = wx.createBannerAd({\r\n                adUnitId: adId,\r\n                adIntervals: 30,\r\n                style: { top: 0, left: 0, width: 300, height: 50 }\r\n            });\r\n            this.bannerAd.onResize(function (res) {\r\n                _this.bannerAd.style.left = (w_1 - res.width) / 2;\r\n                _this.bannerAd.style.top = h_1 - res.height;\r\n                console.log(\"banner 广告 onResize \", res, _this.bannerAd);\r\n            });\r\n            this.bannerAd.onError(function (err) {\r\n                console.warn(\"banner 广告 onError \", err);\r\n            });\r\n            this.bannerAd.hide();\r\n        }\r\n        this.bannerAd.show();\r\n        if (!this.canShowBanner) {\r\n            this.bannerAd.hide();\r\n        }\r\n        if (offset) {\r\n            offset.callback && offset.callback();\r\n        }\r\n    };\r\n    WXGameMgr.prototype.hideBanner = function () {\r\n        this.bannerAd && this.bannerAd.hide();\r\n        this.canShowBanner = false;\r\n    };\r\n    WXGameMgr.prototype.destoryBanner = function () {\r\n        this.bannerAd && this.bannerAd.destroy();\r\n        this.bannerAd = null;\r\n        this.canShowBanner = false;\r\n    };\r\n    WXGameMgr.prototype.showInsertAd = function (data) {\r\n        var _this = this;\r\n        var intersId = this.infos.intersId;\r\n        if (!this.infos.intersOpen || intersId.length <= 0) {\r\n            data.closeFun && data.closeFun();\r\n            return;\r\n        }\r\n        var adId = intersId[Math.floor(Math.random() * intersId.length)];\r\n        console.log(\"创建插屏广告组件-->\", adId);\r\n        this.insertAd = wx.createInterstitialAd({\r\n            adUnitId: adId\r\n        });\r\n        var closeCall = function (res) {\r\n            console.log(\"插屏广告关闭\", res);\r\n            data.closeFun && data.closeFun();\r\n            _this.insertAd.offError(errorCall);\r\n            _this.insertAd.offClose(closeCall);\r\n            _this.insertAd.destroy && _this.insertAd.destroy();\r\n        };\r\n        var errorCall = function (err) {\r\n            console.log(\"插屏广告错误\", err);\r\n            data.errorFun && data.errorFun();\r\n            _this.insertAd.offError(errorCall);\r\n            _this.insertAd.offClose(closeCall);\r\n            _this.insertAd.destroy && _this.insertAd.destroy();\r\n        };\r\n        this.insertAd.onError(errorCall);\r\n        this.insertAd.onClose(closeCall);\r\n        this.insertAd.load().then(function () {\r\n            console.log(\"插屏广告 加载成功\");\r\n            _this.insertAd.show().then(function () {\r\n                console.log(\"插屏广告 显示成功\");\r\n                data.successFun && data.successFun();\r\n            }).catch(function (err) {\r\n                console.warn(\"插屏广告 显示失败\", err);\r\n                errorCall(err);\r\n            });\r\n        }).catch(function (err) {\r\n            console.warn(\"插屏广告 加载失败\", err);\r\n            errorCall(err);\r\n        });\r\n    };\r\n    WXGameMgr.prototype.showGridAd = function () {\r\n        var _this = this;\r\n        if (this.compareVersion(this.systemInfo.SDKVersion, \"2.9.2\") >= 0) {\r\n            var gridId = this.infos.gridId;\r\n            if (gridId.length <= 0)\r\n                return;\r\n            var adId = gridId[Math.floor(Math.random() * gridId.length)];\r\n            console.log(\"创建格子广告组件-->\", adId);\r\n            this.gridAd = wx.createGridAd({\r\n                adUnitId: adId,\r\n                adTheme: \"black\",\r\n                gridCount: 5,\r\n                style: { left: 0, top: 0, width: 100, height: 100 }\r\n            });\r\n            this.gridAd.onError(function (err) {\r\n                console.log(\"格子广告错误\", err);\r\n            });\r\n            this.gridAd.onResize(function (res) {\r\n                console.log(\"格子广告onResize \", res, _this.gridAd);\r\n            });\r\n            this.gridAd.show().then(function () {\r\n                console.log(\"格子广告 显示成功\");\r\n            }).catch(function (err) {\r\n                console.warn(\"格子广告 显示失败\", err);\r\n            });\r\n        }\r\n        else {\r\n            wx.showModal({\r\n                title: \"提示\",\r\n                content: \"当前微信版本过低，无法使用格子广告，请升级到最新微信版本后重试。\"\r\n            });\r\n        }\r\n    };\r\n    WXGameMgr.prototype.hideGridAd = function () {\r\n        if (this.gridAd) {\r\n            this.gridAd.hide();\r\n        }\r\n    };\r\n    WXGameMgr.prototype.vibrateShort = function (data) {\r\n        if (!GameData.getInstance().shakeIsOpen)\r\n            return;\r\n        if (DeviceUtil.isWXMiniGame()) {\r\n            wx.vibrateShort(data);\r\n        }\r\n    };\r\n    WXGameMgr.prototype.vibrateLong = function () {\r\n        if (!GameData.getInstance().shakeIsOpen)\r\n            return;\r\n        if (DeviceUtil.isWXMiniGame()) {\r\n            wx.vibrateLong({});\r\n        }\r\n    };\r\n    WXGameMgr.prototype.sendDataToOpen = function (data) {\r\n        Laya.MiniAdpter.window.wx.postMessage(data);\r\n    };\r\n    WXGameMgr.prototype.removeOpenData = function (data) {\r\n        var wxOpenData = data.parent.getChildByName(\"wxOpenData\");\r\n        this.sendDataToOpen({ cmd: 'close', data: null });\r\n        if (wxOpenData) {\r\n            wxOpenData.removeSelf();\r\n            wxOpenData.destroy();\r\n            wxOpenData = null;\r\n        }\r\n    };\r\n    WXGameMgr.prototype.addOpenData = function (data) {\r\n        var shareData = this.getShareInfo({ id: GameData.getInstance().userInfo.openId });\r\n        this.sendDataToOpen({ cmd: \"share\", data: JSON.stringify(shareData) });\r\n        var wxOpenData = data.parent.getChildByName('wxOpenData');\r\n        if (wxOpenData) {\r\n            wxOpenData.removeSelf();\r\n            wxOpenData.destroy();\r\n            wxOpenData = null;\r\n        }\r\n        wxOpenData = new Laya.WXOpenDataViewer();\r\n        wxOpenData.name = 'wxOpenData';\r\n        wxOpenData.x = data.x || 0;\r\n        wxOpenData.y = data.y || 0;\r\n        wxOpenData.width = data.width;\r\n        wxOpenData.height = data.height;\r\n        if (data.isCenter) {\r\n            wxOpenData.centerX = 0;\r\n            wxOpenData.centerY = 0;\r\n        }\r\n        else {\r\n            if (data.left != null) {\r\n                wxOpenData.left = data.left;\r\n            }\r\n            if (data.right != null) {\r\n                wxOpenData.right = data.right;\r\n            }\r\n            if (data.top != null) {\r\n                wxOpenData.top = data.top;\r\n            }\r\n            if (data.bottom != null) {\r\n                wxOpenData.bottom = data.bottom;\r\n            }\r\n        }\r\n        if (data.parent) {\r\n            data.parent.addChild(wxOpenData);\r\n        }\r\n        return wxOpenData;\r\n    };\r\n    return WXGameMgr;\r\n}(MiniManeger));\r\nexport { WXGameMgr };\r\nvar AdErrCode = {\r\n    1000: \"后端接口调用失败\",\r\n    1001: \"参数错误\",\r\n    1002: \"广告单元无效\",\r\n    1003: \"内部错误\",\r\n    1004: \"无合适的广告\",\r\n    1005: \"广告组件审核中\",\r\n    1006: \"广告组件被驳回\",\r\n    1007: \"广告组件被封禁\",\r\n    1008: \"广告单元已关闭\"\r\n};\r\n",
  "references": [
    "E:/laya/project/laya_firePeople2_git_ts/src/script/minigame/MiniManeger.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameData.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameEvent.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameConst.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/InviteManager.ts"
  ]
}
