{
  "code": "import * as tslib_1 from \"tslib\";\r\nimport { PopBaseScene } from \"../../../PopBaseScene\";\r\nimport GameEvent from \"../../../../common/GameEvent\";\r\nimport SkinMgr from \"../../../../manager/SkinMgr\";\r\nimport BrushItem from \"./BrushItem\";\r\nimport { GameData } from \"../../../../common/GameData\";\r\nimport SoundManager, { SoundConst } from \"../../../../manager/SoundManager\";\r\nimport GameMgr, { Prop } from \"../../../../manager/GameMgr\";\r\nimport { ArrayUtil } from \"../../../../tool/ArrayUtil\";\r\nimport { MiniManeger } from \"../../../../minigame/MiniManeger\";\r\nimport { PageRadio } from \"./PageRadio\";\r\nvar BrushScene = (function (_super) {\r\n    tslib_1.__extends(BrushScene, _super);\r\n    function BrushScene(data) {\r\n        var _this = _super.call(this) || this;\r\n        _this.className_key = \"BrushScene\";\r\n        _this.showEnterType = null;\r\n        _this.curPage = 1;\r\n        _this.maxPage = 3;\r\n        _this.aniArr = [];\r\n        _this.lockArr = [];\r\n        _this.curPageArr = [];\r\n        _this.weightArr = [];\r\n        _this.isPlaying = false;\r\n        _this.distance = 773 + 20;\r\n        _this.price = 100;\r\n        _this.viewData_ = data;\r\n        _this.skin = \"skins/game/type2/brush/BrushView.json\";\r\n        return _this;\r\n    }\r\n    BrushScene.prototype.removeEvent = function () {\r\n        this.btn_get.off(Laya.Event.CLICK, this, this.onGet);\r\n        this.btn_gold.off(Laya.Event.CLICK, this, this.onGoldUglify);\r\n        this.btn_close.off(Laya.Event.CLICK, this, this.onCloseUglify);\r\n        this.box_brush.off(Laya.Event.MOUSE_DOWN, this, this.mouseDown);\r\n        this.box_brush.off(Laya.Event.MOUSE_UP, this, this.mouseUp);\r\n        this.box_brush.off(Laya.Event.MOUSE_OUT, this, this.mouseUp);\r\n        EventMgr.getInstance().removeEvent(GameEvent.USE_BRUSH, this, this.useBrush);\r\n    };\r\n    BrushScene.prototype.onRemoved = function () {\r\n        _super.prototype.onRemoved.call(this);\r\n        this.removeEvent();\r\n        if (this.viewData_.type == 1) {\r\n            EventMgr.getInstance().sendEvent(GameEvent.CHANGE_POS, { _x: 30, _y: 30 });\r\n        }\r\n        else {\r\n            if (GameData.getInstance().channel == \"duyou\" && DeviceUtil.isWXMiniGame()) {\r\n                this.hideBanner();\r\n                GameMgr.instance.topBarIsShow = false;\r\n                GameMgr.instance.bannerIsShow = false;\r\n            }\r\n            EventMgr.getInstance().sendEvent(GameEvent.HIDE_TOP);\r\n        }\r\n        this.brushData = null;\r\n        this.viewData_ = null;\r\n    };\r\n    BrushScene.prototype.initView = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var lab;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (DeviceUtil.isMZMiniGame() || DeviceUtil.isTTMiniGame())\r\n                            this.showInsertAd();\r\n                        if (this.viewData_.type == 1) {\r\n                        }\r\n                        else if (this.viewData_.type == 2) {\r\n                            if (GameData.getInstance().channel == \"duyou\" && DeviceUtil.isWXMiniGame()) {\r\n                                this.showBanner();\r\n                                GameMgr.instance.topBarIsShow = true;\r\n                                GameMgr.instance.bannerIsShow = true;\r\n                            }\r\n                        }\r\n                        EventMgr.getInstance().sendEvent(GameEvent.SHOW_TOP);\r\n                        EventMgr.getInstance().sendEvent(GameEvent.CHANGE_POS, { _x: 30, _y: 30 });\r\n                        this.lab_test.visible = false;\r\n                        this.img_baseBoard.visible = true;\r\n                        this.img_baseBoard.mask = this.lab_test;\r\n                        lab = this.btn_gold.getChildByName(\"num\");\r\n                        lab.text = \"+\" + GameData.getInstance().defaultConfigs.videoBuyGold;\r\n                        return [4, this.refreshUIUglify()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.refreshPageUglify();\r\n                        this.updateBrushUglify();\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrushScene.prototype.showInsertAd = function () {\r\n        MiniManeger.instance.showInsertAd({\r\n            successFun: function () {\r\n            },\r\n            closeFun: function () {\r\n            },\r\n            errorFun: function () {\r\n            }\r\n        });\r\n    };\r\n    BrushScene.prototype.updateBrushUglify = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var data;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, SkinMgr.instance.getCurBrushDataUglify()];\r\n                    case 1:\r\n                        data = _a.sent();\r\n                        if (!data)\r\n                            return [2];\r\n                        this.img_baseBoard.skin = \"resource/assets/imgs/game/type2/brushs/\" + data.icon + \".png\";\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrushScene.prototype.refreshUIUglify = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _a, i, box_1, start, box, i, len, data, item;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _a = this;\r\n                        return [4, SkinMgr.instance.getBrushDataUglify()];\r\n                    case 1:\r\n                        _a.brushData = _b.sent();\r\n                        this.maxPage = Math.ceil(this.brushData.length / 9);\r\n                        for (i = 0; i < this.maxPage; i++) {\r\n                            box_1 = this.box_brush.getChildAt(i);\r\n                            if (!box_1) {\r\n                                box_1 = new Laya.Box();\r\n                                box_1.size(773, 700);\r\n                                box_1.x = (773 + 20) * i;\r\n                                this.box_brush.addChild(box_1);\r\n                            }\r\n                        }\r\n                        start = (this.curPage - 1) * 9;\r\n                        this.curPageArr = this.brushData.slice(start, start + 9);\r\n                        this.weightArr = [];\r\n                        this.lockArr = [];\r\n                        box = this.box_brush.getChildAt(this.curPage - 1);\r\n                        for (i = 0, len = this.curPageArr.length; i < len; i++) {\r\n                            data = this.curPageArr[i];\r\n                            if (!data.unlock) {\r\n                                this.weightArr.push(data.weight);\r\n                                this.lockArr.push(data);\r\n                            }\r\n                            item = box.getChildAt(i);\r\n                            if (item) {\r\n                                item.setData(data);\r\n                            }\r\n                            else {\r\n                                item = new BrushItem(data);\r\n                                item.x = (i % 3) * (209 + 73);\r\n                                item.y = Math.floor(i / 3) * (230 + 5);\r\n                                box.addChild(item);\r\n                            }\r\n                        }\r\n                        this.refreshBtnUglify();\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrushScene.prototype.refreshBtnUglify = function () {\r\n        if (this.lockArr.length) {\r\n            this.btn_comp.visible = false;\r\n            this.btn_get.visible = true;\r\n            var lab = this.btn_get.getChildByName(\"num\");\r\n            lab.text = GameData.getInstance().defaultConfigs.unlockCost2 + \"\";\r\n            this.price = GameData.getInstance().defaultConfigs.unlockCost2;\r\n        }\r\n        else {\r\n            this.btn_comp.visible = true;\r\n            this.btn_get.visible = false;\r\n            this.btn_comp.disabled = true;\r\n        }\r\n    };\r\n    BrushScene.prototype.refreshPageUglify = function () {\r\n        if (!this.com_page) {\r\n            this.com_page = new PageRadio(this.maxPage, 30);\r\n            this.com_page.centerX = 0;\r\n            this.com_page.y = 1350;\r\n            this.box_content.addChild(this.com_page);\r\n        }\r\n        this.com_page.selectIndex = this.curPage - 1;\r\n    };\r\n    BrushScene.prototype.onGet = function () {\r\n        var _this = this;\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        if (this.price <= GameData.getInstance().playerData.gold) {\r\n            GameMgr.instance.updateBaseData(Prop.Gold, -this.price);\r\n            this.enableView(false);\r\n            var randIndex_1 = ArrayUtil.getIndexByWeight(this.weightArr);\r\n            this.aniArr = [];\r\n            console.log(\"随机到的画笔 = \", this.lockArr[randIndex_1]);\r\n            var len = this.curPageArr.length;\r\n            for (var i = 0; i < len - 1; i++) {\r\n                var index1 = this.getIndexByRandom();\r\n                this.aniArr.push(index1);\r\n            }\r\n            this.aniArr.push(randIndex_1);\r\n            console.log(\"this.aniArr ->\", this.aniArr);\r\n            this.playAnimation().then(function () {\r\n                _this.aniArr = [];\r\n                var data = _this.lockArr[randIndex_1];\r\n                SkinMgr.instance.unlockBrushUglify(data.id);\r\n                _this.refreshUIUglify();\r\n                _this.enableView(true);\r\n            });\r\n        }\r\n        else {\r\n            TipsManager.getInstance().showDefaultTips(\"金币不足\");\r\n        }\r\n    };\r\n    BrushScene.prototype.playAnimation = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve) {\r\n            var index = 0;\r\n            var len = _this.aniArr.length;\r\n            var box = _this.box_brush.getChildAt(_this.curPage - 1);\r\n            box.getChildAt(_this.aniArr[index]).showOrHideMask(true);\r\n            Laya.timer.loop(150, _this.box_brush, function () {\r\n                box.getChildAt(_this.aniArr[index]).showOrHideMask(false);\r\n                index++;\r\n                if (index > len - 1) {\r\n                    Laya.timer.clearAll(_this.box_brush);\r\n                    resolve();\r\n                }\r\n                else {\r\n                    box.getChildAt(_this.aniArr[index]).showOrHideMask(true);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrushScene.prototype.getIndexByRandom = function () {\r\n        var len = this.curPageArr.length;\r\n        var index = Math.floor(Math.random() * len);\r\n        var isHas = false;\r\n        for (var i = 0; i < this.aniArr.length; i++) {\r\n            if (index == this.aniArr[i]) {\r\n                isHas = true;\r\n                break;\r\n            }\r\n        }\r\n        if (!isHas) {\r\n            return index;\r\n        }\r\n        else {\r\n            return this.getIndexByRandom();\r\n        }\r\n    };\r\n    BrushScene.prototype.mouseDown = function (evt) {\r\n        if (this.isPlaying || this.maxPage == 1)\r\n            return;\r\n        this.box_brush.on(Laya.Event.MOUSE_UP, this, this.mouseUp);\r\n        this.box_brush.on(Laya.Event.MOUSE_OUT, this, this.mouseUp);\r\n        this.startX = evt.stageX;\r\n    };\r\n    BrushScene.prototype.mouseUp = function (evt) {\r\n        if (this.isPlaying || !this.startX)\r\n            return;\r\n        this.box_brush.off(Laya.Event.MOUSE_UP, this, this.mouseUp);\r\n        this.box_brush.off(Laya.Event.MOUSE_OUT, this, this.mouseUp);\r\n        var a = evt.stageX - this.startX;\r\n        this.startX = null;\r\n        if (a > 0 && Math.abs(a) >= 100) {\r\n            if (this.curPage == 1)\r\n                return;\r\n            this.listAni(1);\r\n        }\r\n        else if (a < 0 && Math.abs(a) >= 100) {\r\n            if (this.curPage == this.maxPage)\r\n                return;\r\n            this.listAni(-1);\r\n        }\r\n    };\r\n    BrushScene.prototype.listAni = function (direction, time) {\r\n        if (time === void 0) { time = 300; }\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.isPlaying = true;\r\n                        this.enableView(false);\r\n                        this.curPage += direction * -1;\r\n                        return [4, this.refreshUIUglify()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4, Promise.all(Array.apply(void 0, Array(this.maxPage)).map(function (v, i) {\r\n                                return _this.singleAni(i, direction, time);\r\n                            }))];\r\n                    case 2:\r\n                        _a.sent();\r\n                        this.refreshPageUglify();\r\n                        this.isPlaying = false;\r\n                        this.enableView(true);\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrushScene.prototype.singleAni = function (index, direction, time) {\r\n        var _this = this;\r\n        return new Promise(function (resolve) {\r\n            var item = _this.box_brush.getChildAt(index);\r\n            var pos = { x: item.x + _this.distance * direction };\r\n            Laya.Tween.to(item, pos, time, null, Laya.Handler.create(_this, function () {\r\n                resolve();\r\n            }));\r\n        });\r\n    };\r\n    BrushScene.prototype.useBrush = function () {\r\n        this.refreshUIUglify();\r\n        this.updateBrushUglify();\r\n    };\r\n    BrushScene.prototype.onGoldUglify = function () {\r\n        var _this = this;\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        this.enableView(false);\r\n        if (GameData.getInstance().videoOpen) {\r\n            MiniManeger.instance.playViderAd({\r\n                successFun: function () {\r\n                    GameMgr.instance.updateBaseData(Prop.Gold, GameData.getInstance().defaultConfigs.videoBuyGold);\r\n                    _this.enableView(true);\r\n                },\r\n                failFun: function () {\r\n                    _this.enableView(true);\r\n                },\r\n                errorFun: function () {\r\n                    _this.enableView(true);\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            MiniManeger.instance.shareAppMessage({\r\n                sucFun: function () {\r\n                    GameMgr.instance.updateBaseData(Prop.Gold, GameData.getInstance().defaultConfigs.videoBuyGold);\r\n                    _this.enableView(true);\r\n                },\r\n                failFun: function () {\r\n                    _this.enableView(true);\r\n                }\r\n            });\r\n        }\r\n    };\r\n    BrushScene.prototype.onCloseUglify = function () {\r\n        SoundManager.instance.playEffect(SoundConst.BtnClick);\r\n        this.removeSelf();\r\n    };\r\n    BrushScene.prototype.childrenCreated = function () {\r\n        _super.prototype.childrenCreated.call(this);\r\n        DeviceUtil.adaptationBgImg(this.img_bg);\r\n        this.box_brush.scrollRect = new Laya.Rectangle(0, 0, 773, 700);\r\n        if (GameData.getInstance().videoOpen) {\r\n            this.btn_gold.getChildByName(\"icon\").skin = \"resource/assets/imgs/public/game_icon_4.png\";\r\n        }\r\n        else {\r\n            this.btn_gold.getChildByName(\"icon\").skin = \"resource/assets/imgs/public/settlement_icon_5.png\";\r\n        }\r\n    };\r\n    BrushScene.prototype.addEvent = function () {\r\n        this.btn_get.on(Laya.Event.CLICK, this, this.onGet);\r\n        this.btn_gold.on(Laya.Event.CLICK, this, this.onGoldUglify);\r\n        this.btn_close.on(Laya.Event.CLICK, this, this.onCloseUglify);\r\n        this.box_brush.on(Laya.Event.MOUSE_DOWN, this, this.mouseDown);\r\n        EventMgr.getInstance().addEvent(GameEvent.USE_BRUSH, this, this.useBrush);\r\n    };\r\n    return BrushScene;\r\n}(PopBaseScene));\r\nexport { BrushScene };\r\n",
  "references": [
    "E:/laya/project/laya_firePeople2_git_ts/src/script/views/PopBaseScene.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameDataType.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameEvent.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/SkinMgr.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/views/games/type2/brush/BrushItem.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameData.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/SoundManager.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/GameMgr.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/tool/ArrayUtil.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/minigame/MiniManeger.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/views/games/type2/brush/PageRadio.ts"
  ]
}
