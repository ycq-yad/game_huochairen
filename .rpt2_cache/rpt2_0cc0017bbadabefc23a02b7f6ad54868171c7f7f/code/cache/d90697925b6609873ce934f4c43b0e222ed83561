{
  "code": "import * as tslib_1 from \"tslib\";\r\nimport { MiniManeger } from \"./MiniManeger\";\r\nimport { GameData } from \"../common/GameData\";\r\nimport GameEvent from \"../common/GameEvent\";\r\nimport InviteManager from \"../manager/InviteManager\";\r\nvar QQGameMgr = (function (_super) {\r\n    tslib_1.__extends(QQGameMgr, _super);\r\n    function QQGameMgr() {\r\n        var _this = _super.call(this) || this;\r\n        _this.appid = \"1110516131\";\r\n        _this.secret = \"2mpUZPZkxWa6AwuP\";\r\n        _this.token = \"8c5d38c8b666d7d95e61bea8333b3eee\";\r\n        _this.url = \"https://yxtest.32yx.com/QQMiniGame.fcgi\";\r\n        _this.hideTime = 0;\r\n        _this.showTime = 0;\r\n        _this.sucTime = 3000;\r\n        _this.defaultMssage = {\r\n            \"title\": \"魔性火柴人在线涂鸦！\",\r\n            \"imageUrl\": \"https://package.32yx.com/ecy_game_small/laya/firePeople2/qq_res/share1.jpg\",\r\n            \"query\": \"\"\r\n        };\r\n        _this.shareInfo = [\r\n            {\r\n                \"title\": \"魔性火柴人在线涂鸦！\",\r\n                \"imageUrl\": \"https://package.32yx.com/ecy_game_small/laya/firePeople2/qq_res/share1.jpg\",\r\n                \"query\": \"\"\r\n            }\r\n        ];\r\n        _this.canShowBanner = true;\r\n        return _this;\r\n    }\r\n    QQGameMgr.prototype.initMiniGame = function () {\r\n        var _this = this;\r\n        this.launchOption = qq.getLaunchOptionsSync();\r\n        console.log(\"launchOption >> \", this.launchOption);\r\n        this.systemInfo = qq.getSystemInfoSync();\r\n        console.log(\"systemInfo >> \", this.systemInfo);\r\n        qq.setKeepScreenOn({ keepScreenOn: true });\r\n        qq.updateShareMenu({ withShareTicket: true });\r\n        qq.showShareMenu({ withShareTicket: true });\r\n        this.defaultMssage.imageUrl = this.defaultMssage.imageUrl + \"?v=\" + new Date().getTime();\r\n        qq.onShareAppMessage(function () {\r\n            return _this.defaultMssage;\r\n        });\r\n        this.getUpdateManager();\r\n    };\r\n    QQGameMgr.prototype.onShow = function (callBack) {\r\n        var _this = this;\r\n        qq.onShow(function (res) {\r\n            callBack && callBack(res);\r\n            _this.showTime = new Date().getTime();\r\n            if (_this.showTime - _this.hideTime >= _this.sucTime) {\r\n                _this.shareSucFun && _this.shareSucFun.call(_this.thisObj);\r\n            }\r\n            else {\r\n                _this.shareFailFun && _this.shareFailFun.call(_this.thisObj);\r\n            }\r\n            _this.shareSucFun = null;\r\n            _this.shareFailFun = null;\r\n            _this.thisObj = null;\r\n            EventMgr.getInstance().sendEvent(GameEvent.ONSHOW);\r\n        });\r\n    };\r\n    QQGameMgr.prototype.onHide = function (callBack) {\r\n        var _this = this;\r\n        qq.onHide(function () {\r\n            callBack && callBack();\r\n            _this.hideTime = new Date().getTime();\r\n            EventMgr.getInstance().sendEvent(GameEvent.ONHIDE);\r\n        });\r\n    };\r\n    QQGameMgr.prototype.onAudioInterruptionBegin = function (callBack) {\r\n        qq.onAudioInterruptionBegin(function () {\r\n            callBack && callBack();\r\n        });\r\n    };\r\n    QQGameMgr.prototype.onAudioInterruptionEnd = function (callBack) {\r\n        qq.onAudioInterruptionEnd(function () {\r\n            callBack && callBack();\r\n        });\r\n    };\r\n    QQGameMgr.prototype.loginGame = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.login().then(function (res) {\r\n                res = JSON.parse(res);\r\n                GameData.getInstance().userInfo.openId = res.openid;\r\n                GameData.getInstance().userInfo.sessionKey = res.session_key;\r\n                _this.initUserInfo();\r\n                resolve();\r\n            }).catch(function (err) {\r\n                reject();\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.checkSession = function () {\r\n        return new Promise(function (resolve) {\r\n            qq.checkSession({\r\n                success: function (res) {\r\n                    console.log(\"session未过期\", res);\r\n                    resolve(false);\r\n                },\r\n                fail: function (res) {\r\n                    console.log(\"session已过期，需要重新登录\", res);\r\n                    resolve(true);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.login = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            qq.login({\r\n                success: function (res) {\r\n                    if (res.code) {\r\n                        console.log(\"code：\", res.code);\r\n                        var urlappend = \"appid=\" + _this.appid + \"&secret=\" + _this.secret + \"&js_code=\" + res.code + \"&grant_type=authorization_code\";\r\n                        qq.request({\r\n                            url: _this.url,\r\n                            method: \"POST\",\r\n                            data: {\r\n                                msg_type: \"10\",\r\n                                msg_data: {\r\n                                    url_append: urlappend,\r\n                                }\r\n                            },\r\n                            success: function (res2) {\r\n                                console.log(\"getsisson 返回：\", res2);\r\n                                resolve(res2.data.msg_data);\r\n                            },\r\n                            fail: function (res3) {\r\n                                console.warn(\"网络请求失败：\", res3);\r\n                                reject();\r\n                            }\r\n                        });\r\n                    }\r\n                    else {\r\n                        console.warn(\"登录失败：\", res);\r\n                        reject();\r\n                    }\r\n                },\r\n                fail: function (err) {\r\n                    console.log(\"login调用失败\", err);\r\n                    reject();\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.queryAuthorization = function (scope) {\r\n        return new Promise(function (resolve) {\r\n            qq.getSetting({\r\n                success: function (res) {\r\n                    if (res.authSetting[scope]) {\r\n                        resolve(true);\r\n                    }\r\n                    else {\r\n                        resolve(false);\r\n                    }\r\n                },\r\n                fail: function (res) {\r\n                    resolve(false);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.getUserInfo = function () {\r\n        return new Promise(function (resolve) {\r\n            qq.getUserInfo({\r\n                withCredentials: false,\r\n                lang: 'zh_CN',\r\n                success: function (res) {\r\n                    console.log(\"获取用户信息成功！\", res);\r\n                    resolve(res.userInfo);\r\n                },\r\n                fail: function (res) {\r\n                    console.log(\"用户未授权\", res);\r\n                    resolve(null);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.createUserInfoButton = function () {\r\n        return new Promise(function (resolve, reject) {\r\n            console.log(\"创建用户信息授权按钮\");\r\n            var button = qq.createUserInfoButton({\r\n                type: \"text\",\r\n                text: \"\",\r\n                style: {\r\n                    left: -300,\r\n                    top: 0,\r\n                    width: 2000,\r\n                    height: 4000,\r\n                    backgroundColor: \"#00000000\",\r\n                    borderColor: \"#00000000\",\r\n                    borderWidth: 1,\r\n                    borderRadius: 1,\r\n                    color: \"#00000000\",\r\n                    textAlign: 'center',\r\n                    fontSize: 16,\r\n                    lineHeight: 40\r\n                },\r\n                withCredentials: false,\r\n                lang: 'zh_CN'\r\n            });\r\n            button.onTap(function (res) {\r\n                console.log(\"用户授权成功！\", res);\r\n                button.destroy();\r\n                resolve(res.userInfo);\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.initUserInfo = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var info;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, this.getUserInfo()];\r\n                    case 1:\r\n                        info = _a.sent();\r\n                        if (!!info) return [3, 3];\r\n                        return [4, this.createUserInfoButton()];\r\n                    case 2:\r\n                        info = _a.sent();\r\n                        _a.label = 3;\r\n                    case 3:\r\n                        GameData.getInstance().userInfo.nick = info.nickName;\r\n                        GameData.getInstance().userInfo.avatarUrl = info.avatarUrl;\r\n                        GameData.getInstance().userInfo.sex = info.gender;\r\n                        this.defaultMssage.query = \"openid=\" + GameData.getInstance().userInfo.openId;\r\n                        this.defaultMssage.imageUrl = this.defaultMssage.imageUrl + \"?v=\" + new Date().getTime();\r\n                        InviteManager.getInstance().judgeInvite();\r\n                        qq.onShareAppMessage(function () {\r\n                            return _this.defaultMssage;\r\n                        });\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    QQGameMgr.prototype.getUpdateManager = function () {\r\n        var updateManager = qq.getUpdateManager();\r\n        updateManager.onCheckForUpdate(function (res) {\r\n            console.log(\"是否有新版本:\", res);\r\n        });\r\n        updateManager.onUpdateReady(function () {\r\n            qq.showModal({\r\n                title: \"更新提示\",\r\n                showCancel: false,\r\n                content: \"新版本已经准备好，是否重启应用？\",\r\n                success: function (res) {\r\n                    res.confirm && updateManager.applyUpdate();\r\n                }\r\n            });\r\n        });\r\n        updateManager.onUpdateFailed(function (err) {\r\n            console.warn(\"新版本更新失败:\", err);\r\n        });\r\n    };\r\n    QQGameMgr.prototype.getShareInfo = function (query) {\r\n        var shareInfo = this.shareInfo;\r\n        var info = shareInfo[Math.floor(Math.random() * shareInfo.length)];\r\n        if (query) {\r\n            var openId = GameData.getInstance().userInfo.openId;\r\n            query[\"openid\"] = openId;\r\n        }\r\n        info.imageUrl = info.imageUrl + \"?v=\" + new Date().getTime();\r\n        info.query = Utils.querStr(query);\r\n        return info;\r\n    };\r\n    QQGameMgr.prototype.shareAppMessage = function (data) {\r\n        if (!data)\r\n            data = {};\r\n        this.shareSucFun = data.sucFun;\r\n        this.shareFailFun = function () {\r\n            TipsManager.getInstance().showDefaultTips(\"分享失败，请分享到群里\");\r\n            data.failFun && data.failFun();\r\n            ;\r\n        };\r\n        this.thisObj = data.thisObj;\r\n        this.sucTime = data.time || this.sucTime;\r\n        if (!data.message) {\r\n            data.message = this.getShareInfo({});\r\n        }\r\n        qq.shareAppMessage(data.message);\r\n    };\r\n    QQGameMgr.prototype.playViderAd = function (data) {\r\n        var _this = this;\r\n        if (!this.infos.videoOpen) {\r\n            data.errorFun && data.errorFun();\r\n            return;\r\n        }\r\n        var videoId = this.infos.videoId;\r\n        if (data.isLongVideo) {\r\n            videoId = this.infos.longVideoId;\r\n        }\r\n        if (videoId.length <= 0) {\r\n            TipsManager.getInstance().showDefaultTips(\"开发中\");\r\n            data.errorFun && data.errorFun();\r\n            return;\r\n        }\r\n        qq.showLoading({ title: \"广告加载中\", mask: true });\r\n        if (!this.videoAd) {\r\n            var adId = videoId[Math.floor(Math.random() * videoId.length)];\r\n            this.videoAd = qq.createRewardedVideoAd({\r\n                adUnitId: adId\r\n            });\r\n            this.videoAd.onLoad(function (res) {\r\n                console.log(\"激励视频广告 加载完成\", res);\r\n            });\r\n        }\r\n        var closeCall = function (res) {\r\n            console.log(\"激励视频广告 关闭\", res);\r\n            if (res.isEnded) {\r\n                data.successFun && data.successFun();\r\n            }\r\n            else {\r\n                data.failFun && data.failFun();\r\n            }\r\n            _this.videoAd.offClose(closeCall);\r\n            _this.videoAd.offError(errorCall);\r\n            qq.hideLoading({});\r\n        };\r\n        var errorCall = function (err) {\r\n            console.warn(\"激励视频广告 错误\", err);\r\n            data.errorFun && data.errorFun(err);\r\n            _this.videoAd.offClose(closeCall);\r\n            _this.videoAd.offError(errorCall);\r\n            qq.hideLoading({});\r\n        };\r\n        this.videoAd.onClose(closeCall);\r\n        this.videoAd.onError(errorCall);\r\n        this.videoAd.load().then(function () {\r\n            console.log(\"激励视频广告 加载成功\");\r\n            _this.videoAd.show().then(function () {\r\n                console.log(\"激励视频广告 显示成功\");\r\n                qq.hideLoading({});\r\n            }).catch(function (err) {\r\n                console.warn(\"激励视频广告 显示失败\", err);\r\n                errorCall(err);\r\n            });\r\n        }).catch(function (err) {\r\n            console.warn(\"激励视频广告 加载失败\", err);\r\n            errorCall(err);\r\n        });\r\n    };\r\n    QQGameMgr.prototype.showBannerAd = function (offset) {\r\n        var _this = this;\r\n        var bannerId = this.infos.bannerId;\r\n        if (!this.infos.bannerOpen || bannerId.length <= 0)\r\n            return;\r\n        this.canShowBanner = true;\r\n        var errorFun = function (err) {\r\n            console.warn(\"banner 广告 onError \", err);\r\n        };\r\n        var createFun = function () {\r\n            var adId = bannerId[Math.floor(Math.random() * bannerId.length)];\r\n            console.log(\"创建 banner 广告组件-->\", adId);\r\n            var phone = _this.systemInfo;\r\n            var w = phone.windowWidth;\r\n            var h = phone.windowHeight;\r\n            _this.clearBannerFun && _this.clearBannerFun();\r\n            _this.clearBannerFun = null;\r\n            var bannerAd = qq.createBannerAd({\r\n                adUnitId: adId,\r\n                style: { top: 0, left: 0, width: 300, height: 50 }\r\n            });\r\n            var resizeFun = function (res) {\r\n                bannerAd.style.left = (w - res.width) / 2;\r\n                bannerAd.style.top = h - res.height;\r\n                console.log(\"banner 广告 onResize \", res, bannerAd);\r\n            };\r\n            var loadFun = function (res) {\r\n                console.log(\"banner 广告 onLoad 成功\", res);\r\n                _this.bannerAd = bannerAd;\r\n                _this.bannerAd.offLoad(loadFun);\r\n                _this.bannerAd.offError(errorFun);\r\n                showFun();\r\n            };\r\n            bannerAd.onError(errorFun);\r\n            bannerAd.onLoad(loadFun);\r\n            bannerAd.onResize(resizeFun);\r\n            _this.clearBannerFun = function () {\r\n                if (_this.bannerAd) {\r\n                    _this.bannerAd.offLoad(loadFun);\r\n                    _this.bannerAd.offResize(resizeFun);\r\n                    _this.bannerAd.offError(resizeFun);\r\n                }\r\n            };\r\n        };\r\n        var showFun = function () {\r\n            if (_this.canShowBanner) {\r\n                _this.bannerAd.show().then(function () {\r\n                    console.log(\"banner广告展示完成\");\r\n                    if (offset) {\r\n                        offset.callback && offset.callback();\r\n                    }\r\n                }).catch(function (err) {\r\n                    errorFun(err);\r\n                });\r\n            }\r\n            else {\r\n                _this.bannerAd.hide();\r\n            }\r\n        };\r\n        if (!this.bannerAd) {\r\n            createFun();\r\n        }\r\n        else {\r\n            showFun();\r\n        }\r\n    };\r\n    QQGameMgr.prototype.hideBanner = function () {\r\n        console.log(\"隐藏banner\");\r\n        this.bannerAd && this.bannerAd.hide();\r\n        this.canShowBanner = false;\r\n    };\r\n    QQGameMgr.prototype.destoryBanner = function () {\r\n        this.clearBannerFun && this.clearBannerFun();\r\n        this.clearBannerFun = null;\r\n        this.bannerAd && this.bannerAd.destroy();\r\n        this.bannerAd = null;\r\n    };\r\n    QQGameMgr.prototype.showInsertAd = function (data) {\r\n        var _this = this;\r\n        if (this.compareVersion(this.systemInfo.SDKVersion, \"1.12.0\") >= 0) {\r\n            var intersId = this.infos.intersId;\r\n            if (!this.infos.intersOpen || intersId.length <= 0) {\r\n                data.closeFun && data.closeFun();\r\n                return;\r\n            }\r\n            var adId_1 = intersId[Math.floor(Math.random() * intersId.length)];\r\n            console.log(\"创建插屏广告组件-->\", adId_1);\r\n            var createCall = function () {\r\n                _this.insertAd = qq.createInterstitialAd({\r\n                    adUnitId: adId_1\r\n                });\r\n                _this.insertAd.onError(errorCall_1);\r\n                _this.insertAd.onLoad(loadCall_1);\r\n            };\r\n            var loadCall_1 = function (res) {\r\n                console.log(\"插屏广告 加载成功\", res);\r\n                _this.insertAd.offError(errorCall_1);\r\n                _this.insertAd.offLoad(loadCall_1);\r\n                showCall_1();\r\n            };\r\n            var showCall_1 = function () {\r\n                _this.insertAd.show().then(function () {\r\n                    console.log(\"插屏广告 显示成功\");\r\n                    data.successFun && data.successFun();\r\n                }).catch(function (err) {\r\n                    console.warn(\"插屏广告 显示失败\", err);\r\n                    errorCall_1(err);\r\n                });\r\n            };\r\n            var closeCall_1 = function (res) {\r\n                console.log(\"插屏广告关闭\", res);\r\n                data.closeFun && data.closeFun();\r\n                _this.insertAd.offError(errorCall_1);\r\n                _this.insertAd.offClose(closeCall_1);\r\n            };\r\n            var errorCall_1 = function (err) {\r\n                console.log(\"插屏广告错误\", err);\r\n                data.errorFun && data.errorFun();\r\n                _this.insertAd.offError(errorCall_1);\r\n                _this.insertAd.offClose(closeCall_1);\r\n                _this.insertAd.destroy && _this.insertAd.destroy();\r\n                _this.insertAd = null;\r\n            };\r\n            if (!this.insertAd) {\r\n                createCall();\r\n            }\r\n            else {\r\n                showCall_1();\r\n            }\r\n            this.insertAd.onClose(closeCall_1);\r\n        }\r\n        else {\r\n            qq.showModal({\r\n                title: \"提示\",\r\n                content: \"当前QQ版本过低，无法使用插屏广告，请升级到最新QQ版本后重试。\"\r\n            });\r\n        }\r\n    };\r\n    QQGameMgr.prototype.showAppBoxAd = function (data) {\r\n        var _this = this;\r\n        if (this.compareVersion(this.systemInfo.SDKVersion, \"1.7.1\") >= 0) {\r\n            var appBoxId = this.infos.appBoxId;\r\n            if (!this.infos.appBoxOpen || appBoxId.length <= 0) {\r\n                data.closeFun && data.closeFun();\r\n                return;\r\n            }\r\n            var adId = appBoxId[Math.floor(Math.random() * appBoxId.length)];\r\n            if (!this.appBoxAd) {\r\n                console.log(\"创建盒子广告组件-->\", adId);\r\n                this.appBoxAd = qq.createAppBox({ adUnitId: adId });\r\n            }\r\n            var closeCall_2 = function (res) {\r\n                console.log(\"盒子广告关闭\", res);\r\n                data.closeFun && data.closeFun();\r\n                _this.appBoxAd.offClose(closeCall_2);\r\n            };\r\n            var errorCall_2 = function (err) {\r\n                console.log(\"盒子广告错误\", err);\r\n                data.errorFun && data.errorFun();\r\n                _this.appBoxAd.offClose(closeCall_2);\r\n                _this.appBoxAd.destroy && _this.appBoxAd.destroy();\r\n                _this.appBoxAd = null;\r\n            };\r\n            this.appBoxAd.onClose(closeCall_2);\r\n            this.appBoxAd.load().then(function () {\r\n                console.log(\"盒子广告 加载成功\");\r\n                _this.appBoxAd.show().then(function () {\r\n                    console.log(\"盒子广告 显示成功\");\r\n                    data.successFun && data.successFun();\r\n                }).catch(function (err) {\r\n                    console.warn(\"盒子广告 显示失败\", err);\r\n                    errorCall_2(err);\r\n                });\r\n            }).catch(function (err) {\r\n                console.warn(\"盒子广告 加载失败\", err);\r\n                errorCall_2(err);\r\n            });\r\n        }\r\n        else {\r\n            qq.showModal({\r\n                title: \"提示\",\r\n                content: \"当前QQ版本过低，无法使用盒子广告，请升级到最新QQ版本后重试。\"\r\n            });\r\n        }\r\n    };\r\n    QQGameMgr.prototype.vibrateShort = function (data) {\r\n        if (!GameData.getInstance().shakeIsOpen)\r\n            return;\r\n        if (DeviceUtil.isQQMiniGame()) {\r\n            qq.vibrateShort(data);\r\n        }\r\n    };\r\n    QQGameMgr.prototype.vibrateLong = function () {\r\n        if (!GameData.getInstance().shakeIsOpen)\r\n            return;\r\n        if (DeviceUtil.isQQMiniGame()) {\r\n            qq.vibrateLong({});\r\n        }\r\n    };\r\n    return QQGameMgr;\r\n}(MiniManeger));\r\nexport { QQGameMgr };\r\nvar AdErrCode = {\r\n    1000: \"后端接口调用失败\",\r\n    1001: \"参数错误\",\r\n    1002: \"广告单元无效\",\r\n    1003: \"内部错误\",\r\n    1004: \"无合适的广告\",\r\n    1005: \"广告组件审核中\",\r\n    1006: \"广告组件被驳回\",\r\n    1007: \"广告组件被封禁\",\r\n    1008: \"广告单元已关闭\"\r\n};\r\n",
  "references": [
    "E:/laya/project/laya_firePeople2_git_ts/src/script/minigame/MiniManeger.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameData.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameEvent.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/common/GameConst.ts",
    "E:/laya/project/laya_firePeople2_git_ts/src/script/manager/InviteManager.ts"
  ]
}
